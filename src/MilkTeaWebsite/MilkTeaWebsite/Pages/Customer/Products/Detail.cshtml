@page
@model MilkTeaWebsite.Pages.Customer.Products.DetailModel
@using System
@{
    ViewData["Title"] = Model.Product?.ProductName ?? "Chi tiết sản phẩm";
    Layout = "~/Pages/Shared/_CustomerLayout.cshtml";

    var heroDescription = string.Empty;
    if (Model.Product != null)
    {
        if (!string.IsNullOrWhiteSpace(Model.Product.Description))
        {
            heroDescription = Model.Product.Description.Length > 140
                ? Model.Product.Description.Substring(0, 137) + "..."
                : Model.Product.Description;
        }
        else
        {
            heroDescription = "Thưởng thức hương vị trà sữa đậm đà được pha chế mỗi ngày.";
        }
    }
}

@section PageHero {
    @if (Model.Product != null)
    {
        <div class="container-xl">
            <div class="hero-banner hero-banner--detail">
                <div class="row align-items-center g-4">
                    <div class="col-lg-7">
                        <div class="hero-eyebrow">
                            <i class="fas fa-tag me-2"></i>@Model.Product.Category?.CategoryName
                        </div>
                        <h1>@Model.Product.ProductName</h1>
                        <p>@heroDescription</p>
                        <div class="hero-detail-meta">
                            <span class="price-pill"><i class="fas fa-coins me-2"></i>Từ @Model.Product.PriceS.ToString("N0") đ</span>
                            <span class="stock-pill">
                                <i class="fas fa-cubes me-2"></i>
                                @(Model.Product.StockQuantity > 0 ? $"Còn {Model.Product.StockQuantity} ly" : "Hết hàng")
                            </span>
                        </div>
                    </div>
                    <div class="col-lg-5 text-lg-end">
                        <div class="hero-product-figure">
                            <img src="@(string.IsNullOrWhiteSpace(Model.Product.ImageUrl) ? "/images/no-image.jpg" : Model.Product.ImageUrl)" alt="@Model.Product.ProductName" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
}

<div class="container-xl product-detail-container">
    @if (Model.Product != null)
    {
        <nav aria-label="breadcrumb" class="breadcrumb-soft">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-page="/Customer/Products/Index"><i class="fas fa-house me-1"></i>Menu</a></li>
                <li class="breadcrumb-item active" aria-current="page">@Model.Product.ProductName</li>
            </ol>
        </nav>

        <div class="product-detail-shell">
            <div class="product-detail-card">
                <div class="row g-4 align-items-start">
                    <div class="col-lg-5">
                        <div class="detail-preview">
                            <div class="detail-preview__image">
                                <img src="@(string.IsNullOrWhiteSpace(Model.Product.ImageUrl) ? "/images/no-image.jpg" : Model.Product.ImageUrl)" alt="@Model.Product.ProductName" class="img-fluid rounded-4" />
                            </div>
                            <div class="detail-preview__meta">
                                <span class="badge bg-soft-pink"><i class="fas fa-fire me-1"></i>@Model.Product.Category?.CategoryName</span>
                                <span class="badge bg-soft-amber"><i class="fas fa-mug-hot me-1"></i>@(Model.Product.StockQuantity > 0 ? $"Có sẵn {Model.Product.StockQuantity} ly" : "Đang pha chế")</span>
                            </div>
                            @if (!string.IsNullOrWhiteSpace(Model.Product.Description))
                            {
                                <p class="detail-preview__description">@Model.Product.Description</p>
                            }
                        </div>
                    </div>
                    <div class="col-lg-7">
                        @if (Model.Product.StockQuantity > 0)
                        {
                            <form method="post" id="add-to-cart-form" class="detail-form">
                                <input type="hidden" asp-for="ProductId" value="@Model.Product.Id" />
                                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                                <div class="detail-form__group">
                                    <label class="detail-form__label">Chọn size yêu thích</label>
                                    <div class="detail-pill-group">
                                        <label class="pill-option">
                                            <input type="radio" name="Size" value="S" data-price="@Model.Product.PriceS" @(Model.Size == "S" ? "checked" : null) />
                                            <span>Size S · @Model.Product.PriceS.ToString("N0")đ</span>
                                        </label>
                                        <label class="pill-option">
                                            <input type="radio" name="Size" value="M" data-price="@Model.Product.PriceM" @(Model.Size == "M" ? "checked" : null) />
                                            <span>Size M · @Model.Product.PriceM.ToString("N0")đ</span>
                                        </label>
                                        <label class="pill-option">
                                            <input type="radio" name="Size" value="L" data-price="@Model.Product.PriceL" @(Model.Size == "L" ? "checked" : null) />
                                            <span>Size L · @Model.Product.PriceL.ToString("N0")đ</span>
                                        </label>
                                    </div>
                                    <small class="form-hint">Giá và dung tích sẽ thay đổi theo size. Size M được chọn mặc định.</small>
                                </div>

                                <div class="detail-form__group">
                                    <label class="detail-form__label">Topping thêm</label>
                                    @if (Model.AvailableToppings.Any())
                                    {
                                        <div class="topping-grid">
                                            @foreach (var topping in Model.AvailableToppings)
                                            {
                                                <div class="topping-item" data-topping-row data-name="@topping.ToppingName" data-price="@topping.ToppingPrice">
                                                    <label class="topping-item__header" for="topping-@topping.Id">
                                                        <input class="form-check-input" type="checkbox" id="topping-@topping.Id" data-topping-checkbox />
                                                        <div>
                                                            <div>@topping.ToppingName</div>
                                                            <small>+@topping.ToppingPrice.ToString("N0")đ</small>
                                                        </div>
                                                    </label>
                                                    <div class="topping-item__qty">
                                                        <button type="button" class="qty-btn" data-topping-decrease disabled>
                                                            <i class="fas fa-minus"></i>
                                                        </button>
                                                        <input type="number" class="qty-input" value="1" min="1" max="5" data-topping-qty disabled />
                                                        <button type="button" class="qty-btn" data-topping-increase disabled>
                                                            <i class="fas fa-plus"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            }
                                        </div>
                                    }
                                    else
                                    {
                                        <div class="alert alert-soft alert-secondary mb-0">
                                            <i class="fas fa-info-circle me-2"></i>Hiện chưa có topping nào cho sản phẩm này.
                                        </div>
                                    }

                                    <input type="hidden" asp-for="ToppingSelectionPayload" id="topping-selection" />
                                    <small class="form-hint"><i class="fas fa-info-circle me-1"></i>Bạn có thể chọn nhiều topping và tùy chỉnh số lượng cho từng loại (tối đa 5).</small>
                                </div>

                                <div class="detail-form__grid">
                                    <div class="detail-form__group">
                                        <label class="detail-form__label" for="quantity-input">Số lượng</label>
                                        <div class="quantity-field">
                                            <button type="button" class="quantity-btn" data-quantity-decrease><i class="fas fa-minus"></i></button>
                                            <input asp-for="Quantity" id="quantity-input" type="number" min="1" max="@Model.Product.StockQuantity" class="form-control detail-input" required />
                                            <button type="button" class="quantity-btn" data-quantity-increase><i class="fas fa-plus"></i></button>
                                        </div>
                                        <small class="form-hint">Còn @Model.Product.StockQuantity ly tại quầy.</small>
                                    </div>
                                </div>

                                <div class="detail-form__group">
                                    <div class="price-summary">
                                        <div class="price-row">
                                            <span>Giá cơ bản:</span>
                                            <strong id="basePrice">@Model.Product.PriceM.ToString("N0")đ</strong>
                                        </div>
                                        <div class="price-row">
                                            <span>Topping:</span>
                                            <strong id="toppingPrice">0đ</strong>
                                        </div>
                                        <div class="price-row">
                                            <span>Số lượng:</span>
                                            <strong id="quantityDisplay">1</strong>
                                        </div>
                                        <div class="price-row price-total">
                                            <span>Tổng cộng:</span>
                                            <strong id="totalPrice">@Model.Product.PriceM.ToString("N0")đ</strong>
                                        </div>
                                    </div>
                                </div>

                                <div class="detail-form__group">
                                    <label class="detail-form__label" for="note-textarea">Ghi chú cho barista</label>
                                    <textarea asp-for="Note" id="note-textarea" class="form-control detail-textarea" rows="3" placeholder="Dặn dò thêm về độ đá, đường, hoặc yêu cầu khác..."></textarea>
                                </div>

                                <div class="detail-actions">
                                    <button type="submit" class="btn btn-primary detail-submit">
                                        <i class="fas fa-cart-plus me-2"></i>Thanh toán
                                    </button>
                                    <a asp-page="/Customer/Products/Index" class="btn btn-outline-secondary detail-back">
                                        <i class="fas fa-chevron-left me-2"></i>Tiếp tục chọn món
                                    </a>
                                </div>
                            </form>
                        }
                        else
                        {
                            <div class="alert alert-warning alert-soft mt-4">
                                <i class="fas fa-exclamation-triangle me-2"></i>Sản phẩm hiện đang hết hàng. Hãy quay lại sau nhé!
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-danger alert-soft">
            <i class="fas fa-exclamation-circle me-2"></i>Không tìm thấy sản phẩm bạn đang tìm kiếm.
        </div>
    }
</div>

@section Scripts {
    <script>
        (function () {
            const form = document.getElementById('add-to-cart-form');
            if (!form) return;

            const quantityInput = form.querySelector('[name="Quantity"]');
            const decreaseBtn = form.querySelector('[data-quantity-decrease]');
            const increaseBtn = form.querySelector('[data-quantity-increase]');
            const sizeRadios = form.querySelectorAll('input[name="Size"]');
            const toppingRows = form.querySelectorAll('[data-topping-row]');
            const toppingPayloadInput = document.getElementById('topping-selection');
            const basePriceEl = document.getElementById('basePrice');
            const toppingPriceEl = document.getElementById('toppingPrice');
            const quantityDisplayEl = document.getElementById('quantityDisplay');
            const totalPriceEl = document.getElementById('totalPrice');

            const buildToppingSelections = () => {
                const selections = [];
                let total = 0;

                toppingRows.forEach(row => {
                    const checkbox = row.querySelector('[data-topping-checkbox]');
                    const qtyInput = row.querySelector('[data-topping-qty]');
                    const price = parseFloat(row.getAttribute('data-price') || '0') || 0;
                    const name = row.getAttribute('data-name') || '';

                    if (!checkbox || !qtyInput || !checkbox.checked) {
                        return;
                    }

                    let qty = parseInt(qtyInput.value || '1', 10);
                    qty = Number.isNaN(qty) ? 1 : Math.max(1, Math.min(5, qty));

                    selections.push({ name, quantity: qty, price });
                    total += price * qty;
                });

                if (toppingPayloadInput) {
                    toppingPayloadInput.value = selections.length ? JSON.stringify(selections) : '';
                }

                return total;
            };

            const clampQuantity = () => {
                if (!quantityInput) return;
                const min = parseInt(quantityInput.getAttribute('min') || '1', 10);
                const max = parseInt(quantityInput.getAttribute('max') || '99', 10);
                let value = parseInt(quantityInput.value || String(min), 10);

                if (Number.isNaN(value)) {
                    value = min;
                }

                value = Math.max(min, Math.min(max, value));
                quantityInput.value = String(value);
                updatePrice();
            };

            const updatePrice = () => {
                let basePrice = 0;
                const selectedSize = form.querySelector('input[name="Size"]:checked');
                if (selectedSize) {
                    basePrice = parseFloat(selectedSize.getAttribute('data-price')) || 0;
                }

                const toppingPrice = buildToppingSelections();
                const quantity = parseInt(quantityInput?.value || '1', 10);
                const total = (basePrice + toppingPrice) * quantity;

                if (basePriceEl) basePriceEl.textContent = basePrice.toLocaleString('vi-VN') + 'đ';
                if (toppingPriceEl) toppingPriceEl.textContent = toppingPrice.toLocaleString('vi-VN') + 'đ';
                if (quantityDisplayEl) quantityDisplayEl.textContent = quantity;
                if (totalPriceEl) totalPriceEl.textContent = total.toLocaleString('vi-VN') + 'đ';
            };

            const bindToppingRow = (row) => {
                const checkbox = row.querySelector('[data-topping-checkbox]');
                const qtyInput = row.querySelector('[data-topping-qty]');
                const decrease = row.querySelector('[data-topping-decrease]');
                const increase = row.querySelector('[data-topping-increase]');

                if (!checkbox || !qtyInput) return;

                const setQtyState = (enabled) => {
                    qtyInput.disabled = !enabled;
                    decrease.disabled = !enabled;
                    increase.disabled = !enabled;
                    row.classList.toggle('topping-item--active', enabled);
                };

                const adjustQty = (delta) => {
                    let value = parseInt(qtyInput.value || '1', 10);
                    value = Number.isNaN(value) ? 1 : value + delta;
                    value = Math.max(1, Math.min(5, value));
                    qtyInput.value = String(value);
                    updatePrice();
                };

                checkbox.addEventListener('change', () => {
                    if (!checkbox.checked) {
                        qtyInput.value = '1';
                    }
                    setQtyState(checkbox.checked);
                    updatePrice();
                });

                decrease?.addEventListener('click', () => adjustQty(-1));
                increase?.addEventListener('click', () => adjustQty(1));
                qtyInput.addEventListener('change', () => adjustQty(0));

                setQtyState(checkbox.checked);
            };

            toppingRows.forEach(bindToppingRow);

            decreaseBtn?.addEventListener('click', () => {
                if (!quantityInput) return;
                quantityInput.stepDown();
                clampQuantity();
            });

            increaseBtn?.addEventListener('click', () => {
                if (!quantityInput) return;
                quantityInput.stepUp();
                clampQuantity();
            });

            quantityInput?.addEventListener('change', clampQuantity);

            sizeRadios.forEach(radio => {
                radio.addEventListener('change', updatePrice);
            });

            updatePrice();
        })();
    </script>
}
