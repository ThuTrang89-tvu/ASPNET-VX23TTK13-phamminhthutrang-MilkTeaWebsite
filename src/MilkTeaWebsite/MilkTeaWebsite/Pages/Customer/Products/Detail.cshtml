@page
@model MilkTeaWebsite.Pages.Customer.Products.DetailModel
@using System
@{
    ViewData["Title"] = Model.Product?.ProductName ?? "Chi tiết sản phẩm";
    Layout = "~/Pages/Shared/_CustomerLayout.cshtml";

    var heroDescription = string.Empty;
    if (Model.Product != null)
    {
        if (!string.IsNullOrWhiteSpace(Model.Product.Description))
        {
            heroDescription = Model.Product.Description.Length > 140
                ? Model.Product.Description.Substring(0, 137) + "..."
                : Model.Product.Description;
        }
        else
        {
            heroDescription = "Thưởng thức hương vị trà sữa đậm đà được pha chế mỗi ngày.";
        }
    }
}

@section PageHero {
    @if (Model.Product != null)
    {
        <div class="container-xl">
            <div class="hero-banner hero-banner--detail">
                <div class="row align-items-center g-4">
                    <div class="col-lg-7">
                        <div class="hero-eyebrow">
                            <i class="fas fa-tag me-2"></i>@Model.Product.Category?.CategoryName
                        </div>
                        <h1>@Model.Product.ProductName</h1>
                        <p>@heroDescription</p>
                        <div class="hero-detail-meta">
                            <span class="price-pill"><i class="fas fa-coins me-2"></i>Từ @Model.Product.PriceS.ToString("N0") đ</span>
                            <span class="stock-pill">
                                <i class="fas fa-cubes me-2"></i>
                                @(Model.Product.StockQuantity > 0 ? $"Còn {Model.Product.StockQuantity} ly" : "Hết hàng")
                            </span>
                        </div>
                    </div>
                    <div class="col-lg-5 text-lg-end">
                        <div class="hero-product-figure">
                            <img src="@(string.IsNullOrWhiteSpace(Model.Product.ImageUrl) ? "/images/no-image.jpg" : Model.Product.ImageUrl)" alt="@Model.Product.ProductName" />
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }
}

<div class="container-xl product-detail-container">
    @if (Model.Product != null)
    {
        <nav aria-label="breadcrumb" class="breadcrumb-soft">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a asp-page="/Customer/Products/Index"><i class="fas fa-house me-1"></i>Menu</a></li>
                <li class="breadcrumb-item active" aria-current="page">@Model.Product.ProductName</li>
            </ol>
        </nav>

        <div class="product-detail-shell">
            <div class="row g-5 align-items-start">
                <div class="col-lg-5">
                    <div class="product-detail__media glass-card">
                        <div class="product-detail__image">
                            <img src="@(string.IsNullOrWhiteSpace(Model.Product.ImageUrl) ? "/images/no-image.jpg" : Model.Product.ImageUrl)" alt="@Model.Product.ProductName" />
                        </div>
                        <div class="product-detail__badges">
                            <span class="detail-badge"><i class="fas fa-seedling me-2"></i>Nguyên liệu tươi mới</span>
                            <span class="detail-badge"><i class="fas fa-truck-fast me-2"></i>Giao trong 30 phút</span>
                        </div>
                        <div class="product-detail__facts">
                            <div class="fact-item">
                                <i class="fas fa-star"></i>
                                <div>
                                    <span class="fact-label">Độ ngọt gợi ý</span>
                                    <strong>50% - 70%</strong>
                                </div>
                            </div>
                            <div class="fact-item">
                                <i class="fas fa-ice-cream"></i>
                                <div>
                                    <span class="fact-label">Phối topping</span>
                                    <strong>Tự chọn</strong>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-7">
                    <div class="product-detail__body glass-card">
                        <div class="detail-header">
                            <h2>@Model.Product.ProductName</h2>
                            <div class="detail-price-stack">
                                <span class="detail-price">Từ @Model.Product.PriceS.ToString("N0") đ</span>
                                <span class="detail-stock @((Model.Product.StockQuantity > 0) ? "in-stock" : "out-stock")">
                                    <i class="fas fa-cubes me-2"></i>@(Model.Product.StockQuantity > 0 ? $"Còn {Model.Product.StockQuantity} ly" : "Hết hàng")
                                </span>
                            </div>
                        </div>

                        @if (!string.IsNullOrWhiteSpace(Model.Product.Description))
                        {
                            <div class="detail-description">
                                @Model.Product.Description
                            </div>
                        }

                        @if (Model.Product.IsAvailable && Model.Product.StockQuantity > 0)
                        {
                            <form method="post" class="detail-form" id="add-to-cart-form">
                                <input type="hidden" asp-for="ProductId" value="@Model.Product.Id" />
                                <input type="hidden" id="priceS" value="@Model.Product.PriceS" />
                                <input type="hidden" id="priceM" value="@Model.Product.PriceM" />
                                <input type="hidden" id="priceL" value="@Model.Product.PriceL" />

                                <!-- Size Selection -->
                                <div class="detail-form__group">
                                    <label class="detail-form__label">Chọn size</label>
                                    <div class="detail-pill-group">
                                        <label class="pill-option">
                                            <input type="radio" name="Size" value="S" data-price="@Model.Product.PriceS" />
                                            <span><i class="fas fa-cup"></i> Size S - @Model.Product.PriceS.ToString("N0")đ</span>
                                        </label>
                                        <label class="pill-option">
                                            <input type="radio" name="Size" value="M" data-price="@Model.Product.PriceM" checked />
                                            <span><i class="fas fa-cup"></i> Size M - @Model.Product.PriceM.ToString("N0")đ</span>
                                        </label>
                                        <label class="pill-option">
                                            <input type="radio" name="Size" value="L" data-price="@Model.Product.PriceL" />
                                            <span><i class="fas fa-cup"></i> Size L - @Model.Product.PriceL.ToString("N0")đ</span>
                                        </label>
                                    </div>
                                </div>

                                @if (Model.AvailableToppings.Any())
                                {
                                    <div class="detail-form__group">
                                        <label class="detail-form__label">
                                            <i class="fas fa-star text-warning"></i> Chọn topping yêu thích
                                        </label>
                                        <div class="detail-pill-group">
                                            @foreach (var topping in Model.AvailableToppings)
                                            {
                                                var isChecked = Model.SelectedToppings.Contains(topping.ToppingName, StringComparer.OrdinalIgnoreCase);
                                                <label class="pill-option">
                                                    <input type="checkbox" 
                                                           name="SelectedToppings" 
                                                           value="@topping.ToppingName" 
                                                           data-price="@topping.ToppingPrice"
                                                           @(isChecked ? "checked" : string.Empty) />
                                                    <span><i class="fas fa-check-circle"></i> @topping.ToppingName (+@topping.ToppingPrice.ToString("N0")đ)</span>
                                                </label>
                                            }
                                        </div>
                                        <small class="form-hint">
                                            <i class="fas fa-info-circle"></i> 
                                            Chỉ cần <strong>tick chọn</strong> các topping bạn muốn ở trên. Không cần nhập text!
                                        </small>
                                    </div>
                                }

                                <div class="detail-form__group">
                                    <label class="detail-form__label" for="custom-topping">
                                        <i class="fas fa-pencil-alt"></i> Topping tùy chỉnh 
                                        <span class="badge bg-secondary">Không bắt buộc</span>
                                    </label>
                                    <input asp-for="CustomTopping" id="custom-topping" class="form-control detail-input" placeholder="Chỉ điền nếu bạn muốn thêm topping đặc biệt không có trong danh sách. Ví dụ: Trân châu hoàng kim" />
                                    <small class="form-text text-muted">
                                        <i class="fas fa-lightbulb"></i> Để trống nếu bạn chỉ chọn topping có sẵn ở trên
                                    </small>
                                </div>

                                <div class="detail-form__grid">
                                    <div class="detail-form__group">
                                        <label class="detail-form__label" for="quantity-input">Số lượng</label>
                                        <div class="quantity-field">
                                            <button type="button" class="quantity-btn" data-quantity-decrease><i class="fas fa-minus"></i></button>
                                            <input asp-for="Quantity" id="quantity-input" type="number" min="1" max="@Model.Product.StockQuantity" class="form-control detail-input" required />
                                            <button type="button" class="quantity-btn" data-quantity-increase><i class="fas fa-plus"></i></button>
                                        </div>
                                        <small class="form-hint">Còn @Model.Product.StockQuantity ly tại quầy.</small>
                                    </div>
                                </div>

                                <!-- Price Summary -->
                                <div class="detail-form__group">
                                    <div class="price-summary">
                                        <div class="price-row">
                                            <span>Giá cơ bản:</span>
                                            <strong id="basePrice">@Model.Product.PriceM.ToString("N0")đ</strong>
                                        </div>
                                        <div class="price-row">
                                            <span>Topping:</span>
                                            <strong id="toppingPrice">0đ</strong>
                                        </div>
                                        <div class="price-row">
                                            <span>Số lượng:</span>
                                            <strong id="quantityDisplay">1</strong>
                                        </div>
                                        <div class="price-row price-total">
                                            <span>Tổng cộng:</span>
                                            <strong id="totalPrice">@Model.Product.PriceM.ToString("N0")đ</strong>
                                        </div>
                                    </div>
                                </div>

                                <div class="detail-form__group">
                                    <label class="detail-form__label" for="note-textarea">Ghi chú cho barista</label>
                                    <textarea asp-for="Note" id="note-textarea" class="form-control detail-textarea" rows="3" placeholder="Dặn dò thêm về độ đá, đường, hoặc yêu cầu khác..."></textarea>
                                </div>

                                <div class="detail-actions">
                                    <button type="submit" class="btn btn-primary detail-submit">
                                        <i class="fas fa-cart-plus me-2"></i>Thêm vào giỏ hàng
                                    </button>
                                    <a asp-page="/Customer/Products/Index" class="btn btn-outline-secondary detail-back">
                                        <i class="fas fa-chevron-left me-2"></i>Tiếp tục chọn món
                                    </a>
                                </div>
                            </form>
                        }
                        else
                        {
                            <div class="alert alert-warning alert-soft mt-4">
                                <i class="fas fa-exclamation-triangle me-2"></i>Sản phẩm hiện đang hết hàng. Hãy quay lại sau nhé!
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="alert alert-danger alert-soft">
            <i class="fas fa-exclamation-circle me-2"></i>Không tìm thấy sản phẩm bạn đang tìm kiếm.
        </div>
    }
</div>

@section Scripts {
    <script>
        (function () {
            const form = document.getElementById('add-to-cart-form');
            if (!form) return;

            const quantityInput = form.querySelector('[name="Quantity"]');
            const decreaseBtn = form.querySelector('[data-quantity-decrease]');
            const increaseBtn = form.querySelector('[data-quantity-increase]');

            // Price calculation elements
            const sizeRadios = form.querySelectorAll('input[name="Size"]');
            const toppingCheckboxes = form.querySelectorAll('input[name="SelectedToppings"]');
            const basePriceEl = document.getElementById('basePrice');
            const toppingPriceEl = document.getElementById('toppingPrice');
            const quantityDisplayEl = document.getElementById('quantityDisplay');
            const totalPriceEl = document.getElementById('totalPrice');

            const clampQuantity = () => {
                if (!quantityInput) return;
                const min = parseInt(quantityInput.getAttribute('min') || '1', 10);
                const max = parseInt(quantityInput.getAttribute('max') || '99', 10);
                let value = parseInt(quantityInput.value || String(min), 10);

                if (Number.isNaN(value)) {
                    value = min;
                }

                value = Math.max(min, Math.min(max, value));
                quantityInput.value = String(value);
                updatePrice();
            };

            const updatePrice = () => {
                // Get selected size price
                let basePrice = 0;
                const selectedSize = form.querySelector('input[name="Size"]:checked');
                if (selectedSize) {
                    basePrice = parseFloat(selectedSize.getAttribute('data-price')) || 0;
                }

                // Calculate topping price
                let toppingPrice = 0;
                toppingCheckboxes.forEach(checkbox => {
                    if (checkbox.checked) {
                        toppingPrice += parseFloat(checkbox.getAttribute('data-price')) || 0;
                    }
                });

                // Get quantity
                const quantity = parseInt(quantityInput?.value || '1', 10);

                // Calculate total
                const total = (basePrice + toppingPrice) * quantity;

                // Update display
                if (basePriceEl) basePriceEl.textContent = basePrice.toLocaleString('vi-VN') + 'đ';
                if (toppingPriceEl) toppingPriceEl.textContent = toppingPrice.toLocaleString('vi-VN') + 'đ';
                if (quantityDisplayEl) quantityDisplayEl.textContent = quantity;
                if (totalPriceEl) totalPriceEl.textContent = total.toLocaleString('vi-VN') + 'đ';
            };

            decreaseBtn?.addEventListener('click', () => {
                if (!quantityInput) return;
                quantityInput.stepDown();
                clampQuantity();
            });

            increaseBtn?.addEventListener('click', () => {
                if (!quantityInput) return;
                quantityInput.stepUp();
                clampQuantity();
            });

            quantityInput?.addEventListener('change', clampQuantity);

            // Add event listeners for price calculation
            sizeRadios.forEach(radio => {
                radio.addEventListener('change', updatePrice);
            });

            toppingCheckboxes.forEach(checkbox => {
                checkbox.addEventListener('change', updatePrice);
            });

            // Initial price calculation
            updatePrice();
        })();
    </script>
}
