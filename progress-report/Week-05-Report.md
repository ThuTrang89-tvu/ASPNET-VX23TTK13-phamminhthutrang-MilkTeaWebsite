# B√ÅO C√ÅO TI·∫æN ƒê·ªò TU·∫¶N 5
**D·ª± √°n:** MilkTeaWebsite - H·ªá th·ªëng Qu·∫£n l√Ω v√† B√°n h√†ng Tr√† S·ªØa  
**Sinh vi√™n:** Ph·∫°m Minh Th∆∞ Trang  
**Tu·∫ßn:** 05 (02/12/2025 - 08/12/2025)  
**Ng√†y b√°o c√°o:** 04/12/2025

---

## üìã M·ª§C TI√äU TU·∫¶N N√ÄY

### M·ª•c ti√™u ch√≠nh:
1. ‚úÖ C·∫£i thi·ªán thi·∫øt k·∫ø database t·ª´ string-based sang relational model
2. ‚úÖ T·∫°o migration cho b·∫£ng quan h·ªá Topping
3. ‚úÖ C·∫≠p nh·∫≠t Service layer ƒë·ªÉ s·ª≠ d·ª•ng b·∫£ng m·ªõi
4. ‚úÖ Migrate seed data sang m√¥ h√¨nh m·ªõi
5. ‚úÖ C·∫≠p nh·∫≠t t√†i li·ªáu b√°o c√°o ph·∫ßn thi·∫øt k·∫ø CSDL

---

## ‚úÖ C√îNG VI·ªÜC ƒê√É HO√ÄN TH√ÄNH

### 1. Database Schema Redesign ‚úÖ

#### V·∫•n ƒë·ªÅ ban ƒë·∫ßu:
- Quan h·ªá Product-Topping ƒë∆∞·ª£c l∆∞u d·∫°ng chu·ªói trong `AvailableToppingIds` (varchar)
- CartItem v√† OrderDetail l∆∞u topping ƒë√£ ch·ªçn d·∫°ng chu·ªói trong `SelectedToppings`
- **Nh∆∞·ª£c ƒëi·ªÉm:**
  - Kh√¥ng c√≥ referential integrity
  - Kh√≥ query v√† th·ªëng k√™
  - Ph·∫£i parse string m·ªói l·∫ßn truy v·∫•n
  - Kh√¥ng b·∫£o to√†n snapshot gi√° ch√≠nh x√°c

#### Gi·∫£i ph√°p tri·ªÉn khai:
T·∫°o 3 b·∫£ng quan h·ªá m·ªõi:

**a) ProductTopping** (Junction table - Many-to-Many)
```sql
CREATE TABLE "ProductToppings" (
    "ProductId" integer NOT NULL,
    "ToppingId" integer NOT NULL,
    CONSTRAINT "PK_ProductToppings" PRIMARY KEY ("ProductId", "ToppingId"),
    CONSTRAINT "FK_ProductToppings_Products" FOREIGN KEY ("ProductId") 
        REFERENCES "Products"("Id") ON DELETE CASCADE,
    CONSTRAINT "FK_ProductToppings_Toppings" FOREIGN KEY ("ToppingId") 
        REFERENCES "Toppings"("Id") ON DELETE CASCADE
);
```

**b) CartItemTopping** (Snapshot table)
```sql
CREATE TABLE "CartItemToppings" (
    "Id" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "CartItemId" integer NOT NULL,
    "ToppingId" integer NOT NULL,
    "ToppingPrice" numeric(18,2) NOT NULL,
    "CreatedAt" timestamp with time zone NOT NULL,
    CONSTRAINT "FK_CartItemToppings_CartItems" FOREIGN KEY ("CartItemId") 
        REFERENCES "CartItems"("Id") ON DELETE CASCADE,
    CONSTRAINT "FK_CartItemToppings_Toppings" FOREIGN KEY ("ToppingId") 
        REFERENCES "Toppings"("Id") ON DELETE RESTRICT
);
```

**c) OrderDetailTopping** (Historical snapshot table)
```sql
CREATE TABLE "OrderDetailToppings" (
    "Id" integer GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "OrderDetailId" integer NOT NULL,
    "ToppingId" integer NOT NULL,
    "ToppingName" character varying(100) NOT NULL,
    "ToppingPrice" numeric(18,2) NOT NULL,
    "CreatedAt" timestamp with time zone NOT NULL,
    CONSTRAINT "FK_OrderDetailToppings_OrderDetails" FOREIGN KEY ("OrderDetailId") 
        REFERENCES "OrderDetails"("Id") ON DELETE CASCADE,
    CONSTRAINT "FK_OrderDetailToppings_Toppings" FOREIGN KEY ("ToppingId") 
        REFERENCES "Toppings"("Id") ON DELETE RESTRICT
);
```

#### K·∫øt qu·∫£:
- ‚úÖ Migration: `20251204125701_AddToppingRelationshipTables`
- ‚úÖ 3 b·∫£ng m·ªõi ƒë√£ t·∫°o th√†nh c√¥ng
- ‚úÖ Indexes t·ªëi ∆∞u ƒë√£ ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông

---

### 2. Entity Classes Update ‚úÖ

#### C√°c thay ƒë·ªïi:

**Product.cs**
```csharp
// Deprecated field with backward compatibility
[Obsolete("Use ProductToppings collection instead")]
public string? AvailableToppingIds { get; set; }

// New navigation property
public virtual ICollection<ProductTopping> ProductToppings { get; set; } 
    = new List<ProductTopping>();
```

**CartItem.cs**
```csharp
[Obsolete("Use CartItemToppings collection instead")]
public string? SelectedToppings { get; set; }

public virtual ICollection<CartItemTopping> CartItemToppings { get; set; } 
    = new List<CartItemTopping>();
```

**OrderDetail.cs**
```csharp
[Obsolete("Use OrderDetailToppings collection instead")]
public string? SelectedToppings { get; set; }

public virtual ICollection<OrderDetailTopping> OrderDetailToppings { get; set; } 
    = new List<OrderDetailTopping>();
```

**Topping.cs**
```csharp
// Added navigation properties
public virtual ICollection<ProductTopping> ProductToppings { get; set; } 
    = new List<ProductTopping>();
public virtual ICollection<CartItemTopping> CartItemToppings { get; set; } 
    = new List<CartItemTopping>();
public virtual ICollection<OrderDetailTopping> OrderDetailToppings { get; set; } 
    = new List<OrderDetailTopping>();
```

#### Chi·∫øn l∆∞·ª£c:
- Gi·ªØ l·∫°i tr∆∞·ªùng c≈© v·ªõi `[Obsolete]` attribute
- Th√™m navigation properties m·ªõi
- **L·ª£i √≠ch:** Backwards compatibility - code c≈© v·∫´n ch·∫°y ƒë∆∞·ª£c

---

### 3. Data Migration ‚úÖ

#### Seed Data Migration:
Chuy·ªÉn ƒë·ªïi 37 quan h·ªá Product-Topping t·ª´ string sang b·∫£ng `ProductToppings`:

```csharp
modelBuilder.Entity<ProductTopping>().HasData(
    // Product 1: Tr√† S·ªØa Truy·ªÅn Th·ªëng (5 toppings)
    new ProductTopping { ProductId = 1, ToppingId = 1 }, // Tr√¢n ch√¢u ƒëen
    new ProductTopping { ProductId = 1, ToppingId = 2 }, // Tr√¢n ch√¢u tr·∫Øng
    new ProductTopping { ProductId = 1, ToppingId = 3 }, // Th·∫°ch d·ª´a
    new ProductTopping { ProductId = 1, ToppingId = 4 }, // Th·∫°ch tr√°i c√¢y
    new ProductTopping { ProductId = 1, ToppingId = 6 }, // Pudding
    // ... 32 relationships more
);
```

#### Migration Applied:
```bash
Migration: 20251204130325_SeedProductToppingRelationships
Status: ‚úÖ Applied successfully
Records inserted: 37 ProductTopping relationships
```

#### Verification:
```sql
SELECT pt."ProductId", p."ProductName", COUNT(pt."ToppingId") as topping_count 
FROM "ProductToppings" pt 
JOIN "Products" p ON pt."ProductId" = p."Id" 
GROUP BY pt."ProductId", p."ProductName";
```

K·∫øt qu·∫£:
| ProductId | ProductName | Topping Count |
|-----------|-------------|---------------|
| 1 | Tr√† S·ªØa Truy·ªÅn Th·ªëng | 5 |
| 2 | Tr√† S·ªØa Socola | 5 |
| 3 | Tr√† S·ªØa Matcha | 5 |
| 4 | Tr√† S·ªØa D√¢u T√¢y | 5 |
| 5 | Tr√† S·ªØa Xo√†i | 4 |
| 6 | Tr√† S·ªØa ƒê√†o | 4 |
| 7 | Tr√† ƒê√†o Cam S·∫£ | 3 |
| 8 | Tr√† Chanh Leo | 3 |
| 9 | Tr√† V·∫£i | 3 |

---

### 4. Service Layer Enhancements ‚úÖ

#### IUnitOfWork Updates:
```csharp
public interface IUnitOfWork
{
    // ... existing repositories
    
    ApplicationDbContext GetDbContext(); // NEW: Access junction tables
    Task<int> SaveChangesAsync();
    void Dispose();
}
```

#### IProductService New Methods:
```csharp
public interface IProductService
{
    // ... existing methods
    
    // NEW: Topping management methods
    Task<IEnumerable<Topping>> GetAvailableToppingsForProductAsync(int productId);
    Task AddToppingToProductAsync(int productId, int toppingId);
    Task RemoveToppingFromProductAsync(int productId, int toppingId);
    Task UpdateProductToppingsAsync(int productId, IEnumerable<int> toppingIds);
}
```

#### ProductService Implementation:
```csharp
public async Task<IEnumerable<Topping>> GetAvailableToppingsForProductAsync(int productId)
{
    var context = _unitOfWork.GetDbContext();
    
    var productToppings = await context.Set<ProductTopping>()
        .Where(pt => pt.ProductId == productId)
        .Include(pt => pt.Topping)
        .ToListAsync();

    return productToppings
        .Select(pt => pt.Topping)
        .Where(t => t.IsAvailable && !t.IsDeleted);
}

// Implementation for Add, Remove, Update methods...
```

---

### 5. DbContext Configuration ‚úÖ

#### Junction Table Configuration:
```csharp
// ProductTopping (Many-to-Many)
modelBuilder.Entity<ProductTopping>(entity =>
{
    entity.HasKey(e => new { e.ProductId, e.ToppingId });
    
    entity.HasOne(e => e.Product)
        .WithMany(p => p.ProductToppings)
        .HasForeignKey(e => e.ProductId)
        .OnDelete(DeleteBehavior.Cascade);
    
    entity.HasOne(e => e.Topping)
        .WithMany(t => t.ProductToppings)
        .HasForeignKey(e => e.ToppingId)
        .OnDelete(DeleteBehavior.Cascade);
});

// CartItemTopping (Snapshot with price)
modelBuilder.Entity<CartItemTopping>(entity =>
{
    entity.HasKey(e => e.Id);
    entity.Property(e => e.ToppingPrice).HasColumnType("decimal(18,2)");
    
    entity.HasOne(e => e.CartItem)
        .WithMany(ci => ci.CartItemToppings)
        .HasForeignKey(e => e.CartItemId)
        .OnDelete(DeleteBehavior.Cascade);
    
    entity.HasOne(e => e.Topping)
        .WithMany(t => t.CartItemToppings)
        .HasForeignKey(e => e.ToppingId)
        .OnDelete(DeleteBehavior.Restrict); // Preserve history
});

// OrderDetailTopping (Historical snapshot)
modelBuilder.Entity<OrderDetailTopping>(entity =>
{
    entity.HasKey(e => e.Id);
    entity.Property(e => e.ToppingName).IsRequired().HasMaxLength(100);
    entity.Property(e => e.ToppingPrice).HasColumnType("decimal(18,2)");
    
    entity.HasOne(e => e.OrderDetail)
        .WithMany(od => od.OrderDetailToppings)
        .HasForeignKey(e => e.OrderDetailId)
        .OnDelete(DeleteBehavior.Cascade);
    
    entity.HasOne(e => e.Topping)
        .WithMany(t => t.OrderDetailToppings)
        .HasForeignKey(e => e.ToppingId)
        .OnDelete(DeleteBehavior.Restrict); // Preserve history
});
```

---

### 6. Documentation Update ‚úÖ

#### B√°o c√°o ƒê·ªì √°n - Ph·∫ßn 2.3 (M√¥ h√¨nh CSDL):
ƒê√£ c·∫≠p nh·∫≠t ho√†n to√†n ph·∫ßn m√¥ t·∫£ database schema:

**N·ªôi dung m·ªõi:**
- Ph√¢n lo·∫°i r√µ: Th·ª±c th·ªÉ ch√≠nh / B·∫£ng quan h·ªá & snapshot
- M√¥ t·∫£ chi ti·∫øt 3 b·∫£ng m·ªõi (ProductTopping, CartItemTopping, OrderDetailTopping)
- Gi·∫£i th√≠ch chi·∫øn l∆∞·ª£c Delete Behavior (Cascade vs Restrict)
- Li·ªát k√™ 4 ∆∞u ƒëi·ªÉm c·ªßa thi·∫øt k·∫ø m·ªõi:
  1. T√≠nh to√†n v·∫πn d·ªØ li·ªáu (Referential Integrity)
  2. Hi·ªáu nƒÉng truy v·∫•n (JOIN thay v√¨ parse string)
  3. B√°o c√°o d·ªÖ d√†ng (GROUP BY, aggregate functions)
  4. B·∫£o to√†n l·ªãch s·ª≠ ch√≠nh x√°c (Price snapshot)

---

## üìä SO S√ÅNH THI·∫æT K·∫æ C≈® V√Ä M·ªöI

| Ti√™u ch√≠ | Thi·∫øt k·∫ø C≈® | Thi·∫øt k·∫ø M·ªöI |
|----------|-------------|--------------|
| **L∆∞u tr·ªØ quan h·ªá** | String "1,2,3,4" | Junction table |
| **Referential Integrity** | ‚ùå Kh√¥ng | ‚úÖ Foreign Keys |
| **Query topping** | Parse string | ‚úÖ JOIN |
| **Th·ªëng k√™** | ‚ùå Ph·ª©c t·∫°p | ‚úÖ GROUP BY |
| **Snapshot gi√°** | ‚ö†Ô∏è Kh√¥ng ch√≠nh x√°c | ‚úÖ Price + Name |
| **B·∫£o to√†n l·ªãch s·ª≠** | ‚ö†Ô∏è String tƒ©nh | ‚úÖ Restrict delete |
| **Performance** | ‚ö†Ô∏è String parsing | ‚úÖ Indexed relations |
| **Maintainability** | ‚ö†Ô∏è Error-prone | ‚úÖ Type-safe |

---

## üîß K·ª∏ THU·∫¨T V√Ä C√îNG C·ª§

### Technologies:
- **ORM:** Entity Framework Core 9.0.10
- **Database:** PostgreSQL 16 (Docker)
- **Migration Tool:** EF Core CLI
- **Pattern:** Repository + Unit of Work

### Commands Used:
```bash
# T·∫°o migration cho b·∫£ng m·ªõi
dotnet ef migrations add AddToppingRelationshipTables --project ../MilkTeaWebsite.DAL

# T·∫°o migration cho seed data
dotnet ef migrations add SeedProductToppingRelationships --project ../MilkTeaWebsite.DAL

# Apply migrations
dotnet ef database update --project ../MilkTeaWebsite.DAL

# Verify database
docker exec milktea_postgres psql -U milktea_user -d MilkTeaDb -c "\dt"
```

---

## üìà K·∫æT QU·∫¢ ƒê·∫†T ƒê∆Ø·ª¢C

### Build Status:
```
‚úÖ Build succeeded
‚ö†Ô∏è 40 warnings (Obsolete attributes - Expected, for backwards compatibility)
‚ùå 0 errors
```

### Database Status:
```
‚úÖ 3 new tables created successfully
‚úÖ 37 ProductTopping relationships seeded
‚úÖ Indexes created and optimized
‚úÖ Foreign keys configured correctly
```

### Code Quality:
```
‚úÖ Navigation properties added
‚úÖ Service layer enhanced with 4 new methods
‚úÖ IUnitOfWork extended with GetDbContext()
‚úÖ Backwards compatibility maintained
```

---

## üéØ L·ª¢I √çCH TH·ª∞C T·∫æ

### 1. T√≠nh To√†n V·∫πn D·ªØ Li·ªáu
- Database t·ª± ƒë·ªông ki·ªÉm tra Topping c√≥ t·ªìn t·∫°i tr∆∞·ªõc khi th√™m
- Kh√¥ng th·ªÉ tham chi·∫øu ƒë·∫øn Topping ƒë√£ x√≥a
- Foreign key constraints b·∫£o ƒë·∫£m consistency

### 2. Query Performance
**Tr∆∞·ªõc:**
```csharp
// Parse string v√† filter
var toppingIds = product.AvailableToppingIds.Split(',');
var toppings = await _context.Toppings
    .Where(t => toppingIds.Contains(t.Id.ToString()))
    .ToListAsync();
```

**Sau:**
```csharp
// Direct JOIN
var toppings = await _context.Set<ProductTopping>()
    .Where(pt => pt.ProductId == productId)
    .Include(pt => pt.Topping)
    .Select(pt => pt.Topping)
    .ToListAsync();
```

### 3. B√°o C√°o & Analytics
```sql
-- Top 5 topping b√°n ch·∫°y nh·∫•t
SELECT t."ToppingName", COUNT(*) as order_count
FROM "OrderDetailToppings" odt
JOIN "Toppings" t ON odt."ToppingId" = t."Id"
GROUP BY t."ToppingName"
ORDER BY order_count DESC
LIMIT 5;

-- Doanh thu t·ª´ topping theo th√°ng
SELECT 
    DATE_TRUNC('month', odt."CreatedAt") as month,
    SUM(odt."ToppingPrice") as topping_revenue
FROM "OrderDetailToppings" odt
GROUP BY month
ORDER BY month;
```

### 4. Historical Accuracy
- OrderDetailTopping l∆∞u c·∫£ t√™n v√† gi√° t·∫°i th·ªùi ƒëi·ªÉm ƒë·∫∑t h√†ng
- Khi Topping ƒë·ªïi t√™n/gi√°, ƒë∆°n c≈© v·∫´n hi·ªÉn th·ªã ƒë√∫ng
- DELETE RESTRICT b·∫£o v·ªá d·ªØ li·ªáu l·ªãch s·ª≠

---

## üöÄ H∆Ø·ªöNG PH√ÅT TRI·ªÇN TI·∫æP THEO

### Tu·∫ßn 6 (Optional):
- [ ] C·∫≠p nh·∫≠t CartService s·ª≠ d·ª•ng CartItemTopping
- [ ] C·∫≠p nh·∫≠t OrderService s·ª≠ d·ª•ng OrderDetailTopping
- [ ] Migrate Razor Pages sang API m·ªõi
- [ ] X√≥a c√°c tr∆∞·ªùng `[Obsolete]` sau khi ho√†n t·∫•t migration

### Features m·ªõi c√≥ th·ªÉ:
- [ ] Dashboard analytics v·ªõi topping statistics
- [ ] Admin page qu·∫£n l√Ω ProductTopping relationships
- [ ] API endpoints cho mobile app
- [ ] Export reports v·ªÅ topping sales

---

## üìù B√ÄI H·ªåC R√öT RA

### 1. Database Design Matters
- Thi·∫øt k·∫ø database ƒë√∫ng t·ª´ ƒë·∫ßu ti·∫øt ki·ªám r·∫•t nhi·ªÅu c√¥ng s·ª©c sau n√†y
- String-based relationships c√≥ v·∫ª ƒë∆°n gi·∫£n ban ƒë·∫ßu nh∆∞ng kh√≥ m·ªü r·ªông
- Normalized design t·ªët h∆°n cho long-term maintenance

### 2. Migration Strategy
- Hybrid approach (gi·ªØ c·∫£ c≈© v√† m·ªõi) gi√∫p migration an to√†n
- `[Obsolete]` attribute l√† c√¥ng c·ª• t·ªët ƒë·ªÉ deprecate code t·ª´ t·ª´
- Test k·ªπ migration tr∆∞·ªõc khi apply l√™n production

### 3. EF Core Best Practices
- Navigation properties m·∫°nh m·∫Ω h∆°n manual JOIN
- Include() v√† AsNoTracking() quan tr·ªçng cho performance
- DbContext kh√¥ng n√™n expose tr·ª±c ti·∫øp, d√πng Repository pattern

---

## üéì K·∫æT LU·∫¨N

Tu·∫ßn 5 ƒë√£ ho√†n th√†nh th√†nh c√¥ng vi·ªác **t√°i c·∫•u tr√∫c database schema** t·ª´ m√¥ h√¨nh string-based sang **relational model chu·∫©n h√≥a**. ƒê√¢y l√† m·ªôt b∆∞·ªõc ti·∫øn quan tr·ªçng v·ªÅ m·∫∑t ki·∫øn tr√∫c, c·∫£i thi·ªán:

- ‚úÖ **T√≠nh to√†n v·∫πn d·ªØ li·ªáu** (Referential Integrity)
- ‚úÖ **Hi·ªáu nƒÉng truy v·∫•n** (Indexed relations)
- ‚úÖ **Kh·∫£ nƒÉng m·ªü r·ªông** (Easy to add features)
- ‚úÖ **Ch·∫•t l∆∞·ª£ng code** (Type-safe, maintainable)

C√¥ng vi·ªác n√†y kh√¥ng ch·ªâ c·∫£i thi·ªán h·ªá th·ªëng hi·ªán t·∫°i m√† c√≤n ƒë·∫∑t n·ªÅn m√≥ng v·ªØng ch·∫Øc cho c√°c t√≠nh nƒÉng ph·ª©c t·∫°p h∆°n trong t∆∞∆°ng lai nh∆∞ analytics, reporting v√† mobile API.

---

**Commit:** `acb9159` - "update"  
**Files Changed:** 12 files  
**Lines Changed:** +500/-100  
**Migration Created:** 2 new migrations  
**Build Status:** ‚úÖ Succeeded

---

_B√°o c√°o ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông b·ªüi GitHub Copilot_  
_Last updated: 04/12/2025_
